<% content_for :title, "Role Management - #{@application.name}" %>

<div class="bg-white shadow sm:rounded-lg">
  <div class="px-4 py-5 sm:p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-medium leading-6 text-gray-900">
        Role Management for <%= @application.name %>
      </h3>
      <%= link_to "← Back to Application", admin_application_path(@application), class: "text-sm text-blue-600 hover:text-blue-500" %>
    </div>

    <% if @application.role_mapping_enabled? %>
      <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
        <div class="flex">
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Role Mapping Configuration</h3>
            <div class="mt-2 text-sm text-blue-700">
              <p>Mode: <strong><%= @application.role_mapping_mode.humanize %></strong></p>
              <% if @application.role_claim_name.present? %>
                <p>Role Claim: <strong><%= @application.role_claim_name %></strong></p>
              <% end %>
              <% if @application.role_prefix.present? %>
                <p>Role Prefix: <strong><%= @application.role_prefix %></strong></p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
        <div class="flex">
          <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Role Mapping Disabled</h3>
            <div class="mt-2 text-sm text-yellow-700">
              <p>Role mapping is currently disabled for this application. Enable it in the application settings to manage roles.</p>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Create New Role -->
    <div class="border-b border-gray-200 pb-6 mb-6">
      <h4 class="text-md font-medium text-gray-900 mb-4">Create New Role</h4>
      <%= form_with(model: [:admin, @application, ApplicationRole.new], url: create_role_admin_application_path(@application), local: true, class: "space-y-4") do |form| %>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div>
            <%= form.label :name, "Role Name", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :name, required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: "admin" %>
          </div>
          <div>
            <%= form.label :display_name, "Display Name", class: "block text-sm font-medium text-gray-700" %>
            <%= form.text_field :display_name, required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: "Administrator" %>
          </div>
        </div>
        <div>
          <%= form.label :description, class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :description, rows: 2, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: "Description of this role's permissions" %>
        </div>
        <div class="flex items-center">
          <%= form.check_box :active, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
          <%= form.label :active, "Active", class: "ml-2 block text-sm text-gray-900" %>
        </div>
        <div>
          <%= form.submit "Create Role", class: "rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600" %>
        </div>
      <% end %>
    </div>

    <!-- Existing Roles -->
    <div class="space-y-6">
      <h4 class="text-md font-medium text-gray-900">Existing Roles</h4>

      <% if @application_roles.any? %>
        <div class="space-y-4">
          <% @application_roles.each do |role| %>
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center space-x-3">
                    <h5 class="text-sm font-medium text-gray-900"><%= role.name %></h5>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <%= role.display_name %>
                    </span>
                    <% unless role.active %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Inactive
                      </span>
                    <% end %>
                  </div>
                  <% if role.description.present? %>
                    <p class="mt-1 text-sm text-gray-500"><%= role.description %></p>
                  <% end %>

                  <!-- Assigned Users -->
                  <div class="mt-3">
                    <p class="text-xs text-gray-500 mb-2">Assigned Users:</p>
                    <div class="flex flex-wrap gap-2">
                      <% role.users.each do |user| %>
                        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                          <%= user.email_address %>
                          <span class="ml-1 text-blue-600">(<%= role.user_role_assignments.find_by(user: user)&.source %>)</span>
                          <%= link_to "×", remove_role_admin_application_path(@application, user_id: user.id, role_id: role.id),
                              method: :post,
                              data: { confirm: "Remove role from #{user.email_address}?" },
                              class: "ml-1 text-blue-600 hover:text-blue-800" %>
                        </span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="text-gray-500 text-sm">
            No roles configured yet. Create your first role above to get started with role-based access control.
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>